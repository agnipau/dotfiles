#!/usr/bin/env bash
#
# Script for downloading a list of song and add id3v2 tags to them.

batch_file="$1"
end_gre="$(wc -l musica_da_scaricare)"
end="$((${end_gre/${batch_file}} - 1))"

mkdir downloaded_music
cd downloaded_music || exit 1

for ((c = 1; c <= end; c += 2)); do
  artist_gre="$(sed -n -e "${c}p" "../${batch_file}")"
  artist="${artist_gre/@*}"
  title_gre="$(sed -n -e "${c}p" "../${batch_file}")"
  title="${title_gre/*@}"
  link="$(sed -n -e "$((c+1))p" "../${batch_file}")"
  short_link="${link/'https://'/}"
  mkdir -p .ydla-temp
  cd .ydla-temp || exit 1
  youtube-dl "$link" \
             --extract-audio --audio-format mp3 --audio-quality 0 \
	     --prefer-ffmpeg --youtube-skip-dash-manifest --ignore-errors \
	     --continue --no-overwrites --restrict-filenames --verbose
  mv ./*.mp3 "../${artist} - ${title}.mp3"
  cd .. || exit 1
  id3v2 --delete-all "${artist} - ${title}.mp3"
  id3v2 --artist "$artist" \
	--song "$title" \
	--comment "$short_link" \
	--track \
	"${artist} - ${title}.mp3"
  notify-send --expire-time=3000 "YouTube" "${artist} - ${title} downloaded"
done
