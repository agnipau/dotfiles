#!/usr/bin/env bash
#
# Converted polybar into tmux status line.
# It works only when in full screen.
# Modified version of the bar script by Dylan Araps.

lum() {
  abr="$(</sys/class/backlight/intel_backlight/brightness)"
  mbr="$(( "$(</sys/class/backlight/intel_backlight/max_brightness)" / 100 ))"
  lum="$((abr / mbr - 1))% \\uf0eb"
}

# Works with ALSA
avol() {
  nperc="$(amixer sget Master \
    | tail -n1 \
    | cut -d' ' -f6 \
    | cut -d[ -f2 \
    | cut -d] -f1)"

  vsta="$(amixer sget Master \
    | tail -n1 \
    | cut -d' ' -f8 \
    | cut -d[ -f2 \
    | cut -d] -f1)"

  if [[ "$vsta" == on ]]; then
    case "$nperc" in
      [0-9]%)  vol="${nperc} \\uf026" ;;
      [1-7]?%) vol="${nperc} \\uf027" ;;
      *)       vol="${nperc} \\uf028" ;;
    esac
  elif [[ "$vsta" == off ]]; then
    vol="muted \\uf026"
  fi
}

# Works with PulseAudio
pvol() {
  nperc="$(pactl list sinks \
    | grep '^[[:space:]]Volume:' \
    | head -n"$((SINK + 1))" \
    | tail -n1 \
    | sed -e 's,.* \([0-9][0-9]*\)%.*,\1,')"

  vsta="$(amixer sget Master \
    | tail -n1 \
    | cut -d' ' -f8 \
    | cut -d[ -f2 \
    | cut -d] -f1)"

  if [[ "$vsta" == on ]]; then
    case "$nperc" in
      [0-9])  vol="${nperc}% \\uf026" ;;
      [1-7]?) vol="${nperc}% \\uf027" ;;
      *)      vol="${nperc}% \\uf028" ;;
    esac
  elif [[ "$vsta" == off ]]; then
    vol="muted \\uf026"
  fi
}

ssid() {
  if [[ -z "$(iwgetid -r)" ]]; then
    ssid="- \\uf1eb"
  elif [[ "$(iwgetid -r)" ]]; then
    ssid="$(iwgetid -r) \\uf1eb"
  fi
}

bat() {
  sta="$(</sys/class/power_supply/BAT0/status)"
  cap="$(</sys/class/power_supply/BAT0/capacity)"

  case "$cap" in
    [0-9])  bat="${cap}% \\uf244" ;;
    [1-3]?) bat="${cap}% \\uf243" ;;
    [4-6]?) bat="${cap}% \\uf242" ;;
    [7-9]?) bat="${cap}% \\uf241" ;;
    *)      bat="100% \\uf240" ;;
  esac

  [[ "$sta" == Charging ]] && \
    bat="\\uf0e7  $bat"
}

ore() {
  ore="$(printf "%(%a %d %H:%M)T" "-1") \\uf017"
}

if (("${1:-165}" >= 164 && "${2:-35}" >= 34)); then
  lum
  pvol
  ssid
  bat
  ore
  [[ "$sta" == Discharging ]] && \
    printf '%b\n' "$lum  $vol   $ssid   $bat    $ore "
  [[ "$sta" == Charging ]] && \
    printf '%b\n' "$lum  $vol   $ssid   $bat   $ore "
fi
