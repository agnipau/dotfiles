#!/usr/bin/env bash
#
# A modified version of an extract from wal.tdesktop-theme/init.sh
# This script takes an hex color (${1}), converts it in rgb, darkens it by
# ${2}% if $2 is a negative number, lighten it by ${2}% if $2 is a positive
# number and finally reconverts it in hex.

if [[ "${2:0:1}" == "-" ]]; then
  modality="negative"
  perc="${2:1}"
elif [[ "${2:0:1}" == "+" ]]; then
  modality="positive"
  perc="${2:1}"
else
  modality="positive"
  perc="$2"
fi

[[ "$perc" -gt 100 || "$perc" -lt 0 ]] && echo "Value must be from 0 to 100." \
                                 && exit 1

c_rgb_12d_bef="$(( 0x"${1:1:2}" ))"
c_rgb_34d_bef="$(( 0x"${1:3:2}" ))"
c_rgb_56d_bef="$(( 0x"${1:5:2}" ))"

if [[ "$modality" == negative ]]; then
  c_rgb_12d_aft="$(( c_rgb_12d_bef - "$((c_rgb_12d_bef * $perc / 100))" ))"
  c_rgb_34d_aft="$(( c_rgb_34d_bef - "$((c_rgb_34d_bef * $perc / 100))" ))"
  c_rgb_56d_aft="$(( c_rgb_56d_bef - "$((c_rgb_56d_bef * $perc / 100))" ))"
elif [[ "$modality" == positive ]]; then
  c_rgb_12d_aft="$(( c_rgb_12d_bef + "$((c_rgb_12d_bef * $perc / 100))" ))"
  c_rgb_34d_aft="$(( c_rgb_34d_bef + "$((c_rgb_34d_bef * $perc / 100))" ))"
  c_rgb_56d_aft="$(( c_rgb_56d_bef + "$((c_rgb_56d_bef * $perc / 100))" ))"
fi

[[ "${c_rgb_12d_aft}" -ge 255 ]] && c_rgb_12d_aft=255
[[ "${c_rgb_34d_aft}" -ge 255 ]] && c_rgb_34d_aft=255
[[ "${c_rgb_56d_aft}" -ge 255 ]] && c_rgb_56d_aft=255

printf -v c_hex_12d '%x' "$c_rgb_12d_aft"
printf -v c_hex_34d '%x' "$c_rgb_34d_aft"
printf -v c_hex_56d '%x' "$c_rgb_56d_aft"

[[ "${#c_hex_12d}" -eq 1 ]] && c_hex_12d="0${c_hex_12d}"
[[ "${#c_hex_34d}" -eq 1 ]] && c_hex_34d="0${c_hex_34d}"
[[ "${#c_hex_56d}" -eq 1 ]] && c_hex_56d="0${c_hex_56d}"

c_hex_final="#${c_hex_12d}${c_hex_34d}${c_hex_56d}"

printf '%s\n' "$c_hex_final"
