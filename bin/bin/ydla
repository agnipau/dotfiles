#!/usr/bin/env bash
#
# Download songs from YouTube and then adds user specified metadata like --title, --artist or --album.
# Requires youtube-dl, ffmpeg and id3v2 for adding metadata to the downloaded mp3.
# Optionally notify-send if you want to receive a notification when download completes.
#
# Syntax:
# ./ydla --artist "Artist of the song" --title "Title of the song" --album "Album name" <link to the song>
# ./ydla --artist "Artist of the song" --title "Title of the song" <link to the song>
# ./ydla <link to the song>
#
# -t | --title
# -a | --artist
# -A | --album

# If present, remove .ydla-temp folder (used for renaming downloaded songs)
rm -rf .ydla-temp

# Actual program
if [[ $# -eq 7 ]]; then
  while [[ -z $hasdof ]]; do
    case $1 in
      -a|--artist)
        artist="$2"
        shift 2
        ;;
      -t|--title)
        title="$2"
        shift 2
        ;;
      -A|--album)
        album="$2"
        shift 2
        hasdof='pastorboe'
        ;;
      *)
        echo -e "Available options are:\n  -a, --artist \"Artist of the song\"\n  -t, --title  \"Title of the song\"\n  -A, --album  \"Album name\"" && exit 1
        ;;
    esac
  done
  mkdir .ydla-temp
  cd .ydla-temp
  youtube-dl $1 \
             --extract-audio --audio-format mp3 --audio-quality 0 --prefer-ffmpeg \
             --youtube-skip-dash-manifest --ignore-errors --continue --restrict-filenames \
             --verbose
  mv *.mp3 ../${artist}\ -\ ${title}.mp3
  cd ..
  id3v2 --delete-all "${artist} - ${title}.mp3"
  id3v2 --artist "$artist" --song "$title" --album "${album}" "${artist} - ${title}.mp3"
  notify-send "YouTube" "$title downloaded"
elif [[ $# -eq 5 ]]; then
  while [[ -z $hasdof ]]; do
    case $1 in
      -a|--artist)
        artist="$2"
        shift 2
        ;;
      -t|--title)
        title="$2"
        shift 2
        hasdof='pastorboe'
        ;;
      *)
        echo -e "Available options are:\n  -a, --artist \"Artist of the song\"\n  -t, --title  \"Title of the song\"\n  -A, --album  \"Album name\"" && exit 1
        ;;
    esac
  done
  mkdir .ydla-temp
  cd .ydla-temp
  youtube-dl $1 \
             --extract-audio --audio-format mp3 --audio-quality 0 --prefer-ffmpeg \
             --youtube-skip-dash-manifest --ignore-errors --continue --restrict-filenames \
             --verbose
  mv *.mp3 ../${artist}\ -\ ${title}.mp3
  cd ..
  id3v2 --delete-all "${artist} - ${title}.mp3"
  id3v2 --artist "$artist" --song "$title" "${artist} - ${title}.mp3"
  notify-send "YouTube" "$title downloaded"
elif [[ $# -eq 1 ]]; then
  youtube-dl $1 \
             --add-metadata --metadata-from-title "%(artist)s - %(title)s" \
             --extract-audio --audio-format mp3 --audio-quality 0 --prefer-ffmpeg \
             --youtube-skip-dash-manifest --ignore-errors --continue --restrict-filenames \
             --verbose
  notify-send "YouTube" "Song downloaded"
else
  echo -e "Available options are:\n  -a, --artist \"Artist of the song\"\n  -t, --title  \"Title of the song\"\n  -A, --album  \"Album name\""
  exit 1
fi

# If present, remove .ydla-temp folder (used for renaming downloaded songs)
rm -rf .ydla-temp
